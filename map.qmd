---
title: "Globe"
format: html
---

```{r}
library(tidyverse)
library(tidymodels)
library(primer.data)
library(knitr)
library(kableExtra)
library(broom)
library(gt)
library(stringr)
library(fixest)

gct <- read_csv("commodity_trade_statistics_data.csv")
```

```{r}
library(tidyverse)
library(plotly)
library(rnaturalearth)
library(rnaturalearthdata)
library(countrycode)

# Load your data
gct <- read_csv("commodity_trade_statistics_data.csv")

# Aggregate total trade per country
gct_map <- gct %>%
  group_by(country_or_area) %>%
  summarize(total_trade = sum(trade_usd, na.rm = TRUE)) %>%
  mutate(
    trade_label = case_when(
      total_trade >= 1e9 ~ paste0("$", round(total_trade / 1e9, 1), "B"),
      total_trade >= 1e6 ~ paste0("$", round(total_trade / 1e6, 1), "M"),
      TRUE ~ paste0("$", round(total_trade, 0))
    ),
    iso_a3 = countrycode(country_or_area, "country.name", "iso3c")
  )

# Merge with world map
world <- ne_countries(scale = "medium", returnclass = "sf") %>%
  left_join(gct_map, by = "iso_a3") %>%
  mutate(
    z = ifelse(is.na(total_trade), -1, total_trade),
    hover_text = ifelse(is.na(total_trade),
                        paste(name, "<br>No data"),
                        paste(name, "<br>", trade_label))
  )

# Custom color scale (exact gray for NA)
color_scale <- list(
  list(0, "rgb(200,200,200)"),
  list(0.000001, "#f5f0e1"),
  list(0.33, "#c2b280"),
  list(0.66, "#8c6d31"),
  list(1, "#5c4422")
)

# Plot with subtitle annotation
plot_ly(world) %>%
  add_trace(
    type = "choropleth",
    locations = ~iso_a3,
    z = ~z,
    text = ~hover_text,
    colorscale = color_scale,
    zmin = -1,
    zmax = max(world$z, na.rm = TRUE),
    hoverinfo = "text",
    marker = list(line = list(width = 0)),
    showscale = TRUE,
    colorbar = list(title = "Trade Value", tickprefix = "$")
  ) %>%
  layout(
    geo = list(
      projection = list(type = "orthographic"),
      showland = TRUE,
      showcountries = TRUE,
      landcolor = "gray90",
      oceancolor = "white",
      countrycolor = "gray20",
      bgcolor = "white",
      showframe = FALSE,
      showcoastlines = FALSE,
      resolution = 50,
      dragmode = "zoom",
      lonaxis = list(showgrid = FALSE),
      lataxis = list(showgrid = FALSE)
    ),
    margin = list(l = 0, r = 0, t = 0, b = 0),
    annotations = list(
      list(
        text = "Note: Gray countries have missing trade data",
        x = 0.5,
        y = -0.15,
        showarrow = FALSE,
        xref = "paper",
        yref = "paper",
        font = list(size = 12, color = "gray20")
      )
    )
  )

```

This globe shows the total recorded trade value for each country, based on all years and commodities in the dataset. Each country reflects its cumulative imports and exports in U.S. dollars, representing its overall trade activity during the observed period.

Countries without data are shown in gray. These include:

Old countries or dissolved regions (e.g., Serbia and Montenegro),

Trade zones or regional groupings (e.g., EU-28, Other Asia, nes),

Or countries with incomplete or missing records.

The globe highlights where trade was most heavily reported and where gaps exist in the data. It gives a high-level view of how global trade is distributed and where itâ€™s missing.
